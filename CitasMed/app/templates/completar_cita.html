@main.route('/cita/<int:cita_id>/completar')
@login_required
def completar_cita(cita_id):
    """Marca una cita como completada después de la atención médica"""
    # Verificar que el usuario sea médico
    if current_user.rol != 'medico':
        flash('Solo los médicos pueden completar citas.', 'danger')
        return redirect(url_for('main.dashboard'))
    
    # Buscar la cita
    cita = Cita.query.get_or_404(cita_id)
    
    # Verificar que el médico es el dueño de esta cita
    if cita.medico_id != current_user.medico.id:
        flash('No tienes permiso para completar esta cita.', 'danger')
        return redirect(url_for('main.dashboard'))
    
    # Verificar que la cita esté en estado programada
    if cita.estado != 'programada':
        flash('Solo se pueden completar citas programadas.', 'warning')
        return redirect(url_for('main.dashboard'))
    
    # Cambiar estado a completada
    cita.estado = 'completada'
    db.session.commit()
    
    flash('✅ Cita marcada como completada exitosamente.', 'success')
    return redirect(url_for('main.dashboard'))
{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center mt-5">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h2 class="card-title text-center">Crear una Cuenta</h2>

                <form method="POST">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="username" class="form-label">Nombre de Usuario:</label>
                            <input type="text" class="form-control" name="username" id="username" required>
                        </div>
                        <div class="col-md-6 mb-3">
    <label for="email" class="form-label">Correo ElectrÃ³nico (Gmail):</label>
    <input type="email" class="form-control" name="email" id="email" 
           required
           placeholder="tucuenta@gmail.com">
    <div id="email-feedback" class="form-text">
        ğŸ“§ debe ingresar su correo Gmail original de paso verifique si coincide, caso contrario no tendra notificaciones!
    </div>
</div>
                    </div>
                    <!-- NUEVO: Campos de telÃ©fono por pais -->
<div class="row">
    <div class="col-md-4 mb-3">
        <label for="codigo_pais" class="form-label">PaÃ­s:</label>
        <select name="codigo_pais" id="codigo_pais" class="form-select">
            <option value="51" selected>ğŸ‡µğŸ‡ª PerÃº (+51)</option>
            <option value="1">ğŸ‡ºğŸ‡¸ USA (+1)</option>
            <option value="52">ğŸ‡²ğŸ‡½ MÃ©xico (+52)</option>
            <option value="54">ğŸ‡¦ğŸ‡· Argentina (+54)</option>
            <option value="55">ğŸ‡§ğŸ‡· Brasil (+55)</option>
            <option value="56">ğŸ‡¨ğŸ‡± Chile (+56)</option>
            <option value="57">ğŸ‡¨ğŸ‡´ Colombia (+57)</option>
            <option value="58">ğŸ‡»ğŸ‡ª Venezuela (+58)</option>
            <option value="34">ğŸ‡ªğŸ‡¸ EspaÃ±a (+34)</option>
        </select>
    </div>
    <div class="col-md-8 mb-3">
        <label for="telefono" class="form-label">TelÃ©fono:</label>
        <input type="tel" class="form-control" name="telefono" id="telefono" 
               placeholder="987654321" pattern="[0-9]{9,12}">
        <div class="form-text">Ejemplo: 987654321 (sin espacios ni guiones)</div>
    </div>
</div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="password" class="form-label">ContraseÃ±a:</label>
                            <input type="password" class="form-control" name="password" id="password" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="rol" class="form-label">Tipo de Cuenta:</label>
                            <select name="rol" id="rol" class="form-select">
                                <option value="paciente">Paciente</option>
                            </select>
                            <div class="form-text">Â¿Eres un mÃ©dico? Registrate como paciente y luego solicita verificaciÃ³n documental para mÃ©dico.</div>
                        </div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Registrarse</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{# script para mostrar el campo de especialidad si se elige "MÃ©dico" #}
<script>
    document.getElementById('rol').addEventListener('change', function () {
        var especialidadContainer = document.getElementById('especialidad-container');
        if (this.value === 'medico') {
            especialidadContainer.style.display = 'block';
            document.getElementById('especialidad').required = true;
        } else {
            especialidadContainer.style.display = 'none';
            document.getElementById('especialidad').required = false;
        }
    });
</script>
{% endblock %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const emailInput = document.getElementById('email');
    const emailFeedback = document.getElementById('email-feedback');
    let timeoutId;

    emailInput.addEventListener('input', function() {
        // Esperar 500ms despuÃ©s de que el usuario deje de escribir
        clearTimeout(timeoutId);
        timeoutId = setTimeout(validarEmail, 500);
    });

    emailInput.addEventListener('blur', function() {
        validarEmail();
    });

function validarEmail() {
    const email = emailInput.value.trim();
    
    if (!email) {
        emailFeedback.innerHTML = 'ğŸ“§ debe ingresar su correo Gmail original de paso verifique si coincide, caso contrario no tendra notificaciones!';
        emailFeedback.className = 'form-text';
        emailInput.classList.remove('is-valid', 'is-invalid');
        return;
    }

    // Mostrar "verificando..." inmediatamente
    emailFeedback.innerHTML = 'ğŸ” Verificando formato Gmail...';
    emailFeedback.className = 'form-text text-warning';
    emailInput.classList.remove('is-valid', 'is-invalid');

    // Llamar al backend
    fetch('/validar-email', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email: email })
    })
    .then(response => response.json())
    .then(data => {
        if (data.valido) {
            emailFeedback.innerHTML = data.mensaje;
            emailFeedback.className = 'form-text text-success fw-bold';
            emailInput.classList.remove('is-invalid');
            emailInput.classList.add('is-valid');
        } else {
            emailFeedback.innerHTML = data.mensaje;
            emailFeedback.className = 'form-text text-danger';
            emailInput.classList.remove('is-valid');
            emailInput.classList.add('is-invalid');
        }
    })
    .catch(error => {
        emailFeedback.innerHTML = 'âš ï¸ Error de conexiÃ³n. Intenta nuevamente.';
        emailFeedback.className = 'form-text text-warning';
    });
}
});
</script>
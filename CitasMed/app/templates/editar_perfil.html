<!-- templates/editar_perfil.html -->
{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center mt-5">
    <div class="col-md-10">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0">
                    {% if current_user.rol == 'medico' %}
                        ğŸ©º Editar Perfil MÃ©dico
                    {% elif current_user.rol == 'paciente' %}
                        ğŸ‘¤ Editar Mi Perfil
                    {% else %}
                        âš™ï¸ Editar Perfil
                    {% endif %}
                </h2>
            </div>
            <div class="card-body">
                
                {# Mensajes flash #}
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category or 'warning' }} alert-dismissible fade show">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <form method="POST">
                    <!-- InformaciÃ³n BÃ¡sica -->
                    <h5 class="mb-3">ğŸ“ InformaciÃ³n BÃ¡sica</h5>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Nombre de Usuario:</label>
                            <input type="text" class="form-control" name="username" 
                                   value="{{ current_user.username }}" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email:</label>
                            <input type="email" class="form-control" name="email" 
                                   value="{{ current_user.email }}" required>
                        </div>
                    </div>

                    <!-- InformaciÃ³n de Contacto -->
                    <h5 class="mb-3 mt-4">ğŸ“ InformaciÃ³n de Contacto</h5>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">PaÃ­s:</label>
                            <select name="codigo_pais" class="form-select" id="codigo_pais">
                                {% set codigo_actual = current_user.telefono[:3] if current_user.telefono and current_user.telefono.startswith('+') else '+51' %}
                                <option value="51" {% if codigo_actual == '+51' %}selected{% endif %}>ğŸ‡µğŸ‡ª PerÃº (+51)</option>
                                <option value="1" {% if codigo_actual == '+1' %}selected{% endif %}>ğŸ‡ºğŸ‡¸ USA (+1)</option>
                                <option value="52" {% if codigo_actual == '+52' %}selected{% endif %}>ğŸ‡²ğŸ‡½ MÃ©xico (+52)</option>
                                <option value="54" {% if codigo_actual == '+54' %}selected{% endif %}>ğŸ‡¦ğŸ‡· Argentina (+54)</option>
                                <option value="55" {% if codigo_actual == '+55' %}selected{% endif %}>ğŸ‡§ğŸ‡· Brasil (+55)</option>
                                <option value="56" {% if codigo_actual == '+56' %}selected{% endif %}>ğŸ‡¨ğŸ‡± Chile (+56)</option>
                                <option value="57" {% if codigo_actual == '+57' %}selected{% endif %}>ğŸ‡¨ğŸ‡´ Colombia (+57)</option>
                                <option value="58" {% if codigo_actual == '+58' %}selected{% endif %}>ğŸ‡»ğŸ‡ª Venezuela (+58)</option>
                                <option value="34" {% if codigo_actual == '+34' %}selected{% endif %}>ğŸ‡ªğŸ‡¸ EspaÃ±a (+34)</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">TelÃ©fono:</label>
                            {% if current_user.telefono and current_user.telefono.startswith('+') %}
                                {% set numero_actual = current_user.telefono[3:] %}
                            {% else %}
                                {% set numero_actual = current_user.telefono or '' %}
                            {% endif %}
                            <input type="tel" class="form-control" name="telefono" 
                                   value="{{ numero_actual }}" placeholder="celular" 
                                   pattern="[0-9]{7,12}">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">MÃ©todo de Contacto Preferido:</label>
                        <select name="metodo_contacto" class="form-select">
                            <option value="email" {% if current_user.metodo_contacto_preferido == 'email' %}selected{% endif %}>ğŸ“§ Email</option>
                            <option value="sms" {% if current_user.metodo_contacto_preferido == 'sms' %}selected{% endif %}>ğŸ’¬ SMS</option>
                        </select>
                        <div class="form-text">CÃ³mo prefieres recibir recordatorios de tus citas</div>
                    </div>

                    <!-- InformaciÃ³n Personal -->
                    <h5 class="mb-3 mt-4">ğŸ‘¤ InformaciÃ³n Personal</h5>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Fecha de Nacimiento (opcional):</label>
                            <input type="date" class="form-control" name="fecha_nacimiento" 
                                   value="{{ current_user.fecha_nacimiento or '' }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">GÃ©nero (opcional):</label>
                            <select name="genero" class="form-select">
                                <option value="">Seleccionar...</option>
                                <option value="masculino" {% if current_user.genero == 'masculino' %}selected{% endif %}>Masculino</option>
                                <option value="femenino" {% if current_user.genero == 'femenino' %}selected{% endif %}>Femenino</option>
                                <option value="otro" {% if current_user.genero == 'otro' %}selected{% endif %}>Otro</option>
                            </select>
                        </div>
                    </div>

                    <!-- BiografÃ­a y Foto (PARA TODOS) -->
                    <h5 class="mb-3 mt-4">ğŸ“– Sobre MÃ­</h5>
                    
                    <div class="mb-3">
                        <label class="form-label">BiografÃ­a:</label>
                        <textarea name="biografia" class="form-control" rows="4" 
                                  placeholder="{% if current_user.rol == 'medico' %}Describe tu experiencia, especializaciÃ³n y enfoque mÃ©dico...{% else %}Comparte alguna informaciÃ³n sobre ti (opcional)...{% endif %}">
                            {%- if current_user.rol == 'medico' and current_user.medico -%}
                                {{ current_user.medico.biografia or '' }}
                            {%- else -%}
                                {{ current_user.biografia or '' }}
                            {%- endif -%}
                        </textarea>
                        <div class="form-text">
                            {% if current_user.rol == 'medico' %}
                                Esta informaciÃ³n serÃ¡ visible para los pacientes.
                            {% else %}
                                InformaciÃ³n opcional sobre ti.
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">URL Foto de Perfil:</label>
                        <input type="url" name="foto_perfil" class="form-control" 
                               value="{% if current_user.rol == 'medico' and current_user.medico %}{{ current_user.medico.foto_perfil or '' }}{% else %}{{ current_user.foto_perfil or '' }}{% endif %}" 
                               placeholder="https://ejemplo.com/tu-foto.jpg">
                        <div class="form-text">Enlace a tu foto de perfil (opcional)</div>
                    </div>

                    <!-- InformaciÃ³n MÃ©dica (SOLO PARA MÃ‰DICOS) -->
                    {% if current_user.rol == 'medico' and current_user.medico %}
                    <h5 class="mb-3 mt-4">ğŸ©º InformaciÃ³n Profesional</h5>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Especialidad:</label>
                            <input type="text" class="form-control" 
                                   value="{{ current_user.medico.especialidad }}" 
                                   disabled readonly>
                            <div class="form-text">Contacta al administrador para cambiar</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Licencia MÃ©dica:</label>
                            <input type="text" class="form-control" 
                                   value="{{ current_user.medico.licencia_medica or 'No registrada' }}" 
                                   disabled readonly>
                        </div>
                    </div>
                    {% endif %}

                    <div class="d-flex justify-content-between mt-4">
                        <a href="{{ url_for('main.ver_perfil') }}" class="btn btn-secondary">â† Cancelar</a>
                        <button type="submit" class="btn btn-primary">ğŸ’¾ Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Actualizar visualizaciÃ³n del telÃ©fono en tiempo real
document.addEventListener('DOMContentLoaded', function() {
    const codigoPais = document.getElementById('codigo_pais');
    const inputTelefono = document.querySelector('input[name="telefono"]');
    
    function actualizarEjemplo() {
        const ejemplo = document.getElementById('ejemplo-telefono');
        if (!ejemplo) return;
        
        if (inputTelefono.value) {
            ejemplo.textContent = `TelÃ©fono completo: +${codigoPais.value}${inputTelefono.value}`;
            ejemplo.className = 'form-text text-success fw-bold';
        } else {
            ejemplo.textContent = 'Ejemplo: 987654321 (se guardarÃ¡ como +51987654321)';
            ejemplo.className = 'form-text';
        }
    }
    
    codigoPais.addEventListener('change', actualizarEjemplo);
    inputTelefono.addEventListener('input', actualizarEjemplo);
    actualizarEjemplo();
});
</script>
{% endblock %}